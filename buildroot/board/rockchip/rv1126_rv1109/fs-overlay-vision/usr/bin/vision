#!/bin/bash

POSITIONAL_ARGS=()
SERVICES=( autopilot camera detection display msp osd qr tracker video )
declare -A SERVICES_SCRIPTS

SERVICES_SCRIPTS=(
    ["autopilot"]=""
    ["msp"]="/etc/init.d/S50vision-msp-service"
    ["camera"]="/etc/init.d/S51vision-camera-service"
    ["video"]="/etc/init.d/S52vision-video-service"
    ["osd"]="/etc/init.d/S53vision-osd-service"
    ["qr"]="/etc/init.d/S55vision-qr-scanner-service"
    ["display"]="/etc/init.d/S56vision-display-service"
    ["detection"]="/etc/init.d/S99vision-detection-service"
    ["tracker"]=""
)

service_op () {
    SERVICE=$1
    OP=$2
    if [[ "$OP" = "status" ]] ; then
        ps aux | grep `grep "NAME=" ${SERVICES_SCRIPTS[$SERVICE]} | sed 's/NAME=//'`
    else
        ${SERVICES_SCRIPTS[$SERVICE]} $OP
    fi
}

help() {
  echo "vision [${SERVICES[*]}] [start|stop|restart|status] - to operate specific service"
  echo "vision [start|stop|restart|status] - to operate all vison services"
}

status() {
  printf "|-----------------------------|\n"
  printf "|%-10s|%-6s|%-5s|%-5s|\n" SERVICE PID CPU% MEM%
  printf "|----------|------|-----|-----|\n"
  for service in ${SERVICES[*]}; do
    printf "|%-10s|%-6s|%-5s|%-5s|\n" $service `(ps aux | grep "vision-$service" | grep -v grep | awk '{ print $2" "$3" "$4 }')`
  done
  printf "|-----------------------------|\n"
}

while [[ $# -gt 0 ]]; do
  case $1 in
	*)
    [[ ${SERVICES[*]} =~ $1 ]] \
      && service_op "$1" "$2" \
      && exit 0
      ;;&
    status)
      status
      exit 0
      ;;
    restart | stop | start)
      for f in /etc/init.d/*vision*; do
          $f $1 
      done
      exit 0
      ;;
    help)
      help
      exit 0
      ;;
    *)
      echo "Unknown option $1"
      exit 1
      ;;
  esac
done

